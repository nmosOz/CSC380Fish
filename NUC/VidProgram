import cv2 as cv
import time
import os
from time import sleep
from datetime import datetime
import subprocess

# Gets the length of the videos in minutes
Tm = 30

# Gets the number of videos recorded, anything below 0 is infinite
Ln = -1

# This function is because the room is black from 7pm - 7am (Doesn't record during that time because the camera has no night-vision feature)
def TimeCheck():
   print("TimeCheck")
   if int(datetime.now().strftime("%H")) >= 19:
      T = 25200+(24-int(datetime.now().strftime("%H")))*3600 - (int(datetime.now().strftime("%M")))*60 - int(datetime.now().strftime("%S"))
      sleep(T)
   elif int(datetime.now().strftime("%H")) < 7:
      T = (7-int(datetime.now().strftime("%H")))*3600 - (int(datetime.now().strftime("%M")))*60 - int(datetime.now().strftime("%S"))
      sleep(T)
   return

# Compresses the videos and sends them to the website (Parallel to the main method)
def VidMagic(Time):
   # Splits the video's name depending on its length
   TimeR = ""
   if (Tm>=(3599.9)):
      TimeR = Time.split(":")[0]
   elif ((Tm<(3599.9)) and (Tm>=(59.9))):
      TimeR = Time.split(":")[0] + ":" + Time.split(":")[1]
   else:
      TimeR = Time
   Time = "/home/teamfish/Desktop/VidProgram/Videos/" + Time + "t.mp4"
   TimeR = "/home/teamfish/Desktop/VidProgram/Videos/" + TimeR + ".mp4"
   
   # Compresses the video
   subprocess.run(["ffmpeg", "-i", Time, "-vcodec", "libx264", TimeR])
   
   # Sends the video to the Oswego servers
   subprocess.run(["sshpass", "-p", "7Lifezgray", "scp", TimeR, "aprice3@pi.cs.oswego.edu:Desktop/Website/static/fish_videos"])
   
   #Deletes both the temporary and new video from the NUC
   subprocess.run(["rm", Time])
   subprocess.run(["rm", TimeR])

# Main function
def Rec():
   TimeCheck()
   cap = cv.VideoCapture(0)
   Time = datetime.now().strftime("%m_%d_%y@%H:%M:%S")
   
   # Creates a video writer, * THE PATH SPECIFIED IS TEMPORARY
   result = cv.VideoWriter("/home/teamfish/Desktop/VidProgram/Videos/" + Time + "t.mp4", cv.VideoWriter_fourcc(*'mp4v'), 30, (int(cap.get(3)),int(cap.get(4))))
 
   # Gets the time before any frames are written to the video
   start_time = time.time()
   
   # Writes the video to a temporary file, to be sent to the servers later
   while (True):
      ret, frame = cap.read()
      if ret == True:
          result.write(frame)
          cv.imshow("Video",frame)
          if cv.waitKey(1) == ord('q'):
             break
          if ((time.time() - start_time)>=Tm): #If the video is the correct length, ends the iteration
             break
     
   # Releases the temporary video and gets ready for a new loop
   cv.destroyAllWindows()
   cap.release()
   
   # Forks the video, compressing, sending, and deleting the video while creating a new loop (Works with different lengths of videos)
   Fork = os.fork()
   if Fork == 0:
      TimeT = Time
      VidMagic(TimeT)
      os._exit(0)

Tm = Tm * 60 - .1 #converts the time from minutes to seconds

# Runs the program
while (Ln!=0):
   Rec()
   Ln -= 
